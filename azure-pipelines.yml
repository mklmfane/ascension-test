trigger: none

variables:
  serviceConnection: 'terraform-access'   # <- exact service connection NAME


stages:
- stage: tf
  jobs:
  - job: plan
    pool:
      name: 'ubuntuvm'
    steps:
    - task: AzureCLI@2
      displayName: 'Login with OIDC'
      inputs:
        azureSubscription: '$(serviceConnection)'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          # Export ARM_* for the next step from the service connection context
          echo "##vso[task.setvariable variable=ARM_CLIENT_ID]$servicePrincipalId"
          echo "##vso[task.setvariable variable=ARM_TENANT_ID]$tenantId"
          echo "##vso[task.setvariable variable=ARM_SUBSCRIPTION_ID]$subscriptionId"
          az account show
    - script: |
        terraform -version
        cd terraform
        terraform init
        terraform plan
      displayName: 'Terraform init'
      env:
        ARM_USE_OIDC: "true"
        ARM_CLIENT_ID: $(ARM_CLIENT_ID)
        ARM_TENANT_ID: $(ARM_TENANT_ID)
        ARM_SUBSCRIPTION_ID: $(ARM_SUBSCRIPTION_ID)
      workingDirectory: $(Build.SourcesDirectory) 