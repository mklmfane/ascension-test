# azure-pipelines.yml
trigger: none

variables:
  serviceConnection: 'terraform-access'   # EXACT service connection name

stages:
- stage: tf
  jobs:
  - job: plan
    pool:
      name: 'ubuntuvm'                    # your self-hosted agent pool
    steps:
    - checkout: self
      clean: true

    # Login and run terraform in the same step
    - task: AzureCLI@2
      displayName: 'Login with OIDC and terraform plan'
      inputs:
        azureSubscription: '$(serviceConnection)'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -euo pipefail
          terraform -version
          terraform -chdir=terraform init -input=false
          terraform -chdir=terraform validate
          terraform -chdir=terraform plan -input=false -out=tfplan.out
